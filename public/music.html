<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JARVIS Music ‚Äî Premium (Blue)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1114;
    --panel:#0e1618;
    --muted:#9aa6a1;
    --glass: rgba(255,255,255,0.03);
    --accent:#1d7bff; /* JARVIS Blue */
    --accent-2:#1d7bff;
    --card-shadow: 0 10px 30px rgba(2,6,10,0.6);
    --text:#e9f2ef;
  }

  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background:linear-gradient(180deg,#071017 0%, #041014 100%);
    color:var(--text);-webkit-font-smoothing:antialiased}

  /* NAV */
  nav{
    position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;padding:0 20px;z-index:40;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));
    backdrop-filter: blur(8px);border-bottom:1px solid rgba(255,255,255,0.02);
  }
  nav .nav-left{display:flex;gap:14px;align-items:center}
  .logo{display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:var(--card-shadow)}
  .dot{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--accent-2), #6ad1ff);display:flex;align-items:center;justify-content:center;font-weight:800;color:#031017}
  #navLinks { display:flex; gap:28px; list-style:none; margin:0; padding:0; position:absolute; left:50%; transform:translateX(-50%); align-items:center; }
  #navLinks li a { color:#dffaff; text-decoration:none; padding:8px 14px; font-weight:600; border-radius:10px }

  .hamburger{display:none; flex-direction:column; gap:6px; cursor:pointer; position:absolute; right:20px}
  .hamburger span{width:26px;height:3px;border-radius:2px;background:#e3f9ff;display:block}

  /* layout */
  .page { display:grid; grid-template-columns: 220px 1fr 320px; gap:22px; padding:100px 28px 140px; min-height:calc(100vh - 140px) }
  .sidebar { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:16px; box-shadow:var(--card-shadow); height:calc(100vh - 140px); position:sticky; top:80px; overflow:auto }
  .nav-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;color:var(--muted);cursor:pointer}
  .playlist-list{margin-top:12px;display:flex;flex-direction:column;gap:8px}
  .pl-btn{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.02);color:var(--muted);cursor:pointer}

  /* main */
  .main { display:flex;flex-direction:column; gap:20px }
  .hero { display:flex; justify-content:space-between; align-items:center; gap:16px }
  .hero .title { font-size:24px; font-weight:800 }
  .searchbar { display:flex; gap:10px; align-items:center; width:480px }
  .searchbar input{flex:1;padding:10px 12px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:var(--text)}
  .searchbar button{padding:10px 12px;border-radius:10px;border:none;background:var(--accent-2);color:#071018;font-weight:700;cursor:pointer}

  .song-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;margin-top:6px}
  .song-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:10px;cursor:pointer;position:relative;overflow:hidden;transition:transform .18s,box-shadow .18s;min-height:220px;display:flex;flex-direction:column}
  .song-card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,10,0.6)}
  .song-cover{width:100%;height:140px;object-fit:cover;border-radius:8px;display:block}
  .song-meta{margin-top:8px}
  .song-meta .title{font-weight:700;font-size:14px;color:var(--text)}
  .song-meta .artist{font-size:13px;color:var(--muted);margin-top:4px}
  .add-to-pl-btn{position:absolute;top:8px;right:8px;width:34px;height:34px;border-radius:8px;border:none;background:rgba(0,0,0,0.45);color:#fff;font-weight:700;cursor:pointer}

  /* right panel */
  .right-panel { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:16px;box-shadow:var(--card-shadow); height:calc(100vh - 140px); position:sticky; top:80px; overflow:auto }
  .right-panel h4{margin:0 0 10px 0}

  /* bottom player */
  .player-bar{position:fixed;left:0;right:0;bottom:0;height:96px;background:#071017;border-top:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;gap:20px;padding:10px 24px;z-index:60}
  .player-left{display:flex;align-items:center;gap:12px}
  .player-cover{width:64px;height:64px;border-radius:6px;overflow:hidden;background:#0b0f12}
  .btn{width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,0.03);border:none;color:#fff;display:grid;place-items:center;cursor:pointer}
  .btn.play{width:56px;height:56px;background:var(--accent);color:#071018;font-weight:800;font-size:18px}
  .progress{width:420px;height:8px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;margin-left:20px}
  .progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent), #9cffb8)}

  .wave-container{display:flex;align-items:flex-end;gap:4px;height:30px}
  .wave-bar{width:4px;background:var(--accent);border-radius:2px;height:8px;animation:wave 0.6s infinite;animation-play-state:paused;--scale:1}
  @keyframes wave{0%{height:8px}50%{height:calc(8px + 18px * var(--scale))}100%{height:8px}}

  @media(max-width:1100px){ .page{grid-template-columns:200px 1fr} .right-panel{display:none} .progress{display:none} }
  @media(max-width:720px){
    #navLinks{display:none}
    .hamburger{display:flex}
    .sidebar{position:fixed;left:-260px;top:64px;height:calc(100vh - 64px);z-index:50;transition:transform .28s}
    .sidebar.open{transform:translateX(260px)}
    .page{grid-template-columns:1fr;padding:120px 12px 140px}
    .player-bar{padding:8px 12px}
  }

  .muted{color:var(--muted)}

/* small tweaks to make it premium-looking */
  .song-meta .title { font-size:15px }
  .song-card .artist { opacity:0.9 }
</style>
</head>
<body>

<!-- NAVBAR -->
<nav>
  <div class="nav-left">
    <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>
    <div class="logo" style="cursor:default"><div class="dot">J</div>
      <div><h1 style="font-size:14px;margin:0">JARVIS Music</h1><div style="font-size:11px;color:var(--muted);margin-top:2px">Your mini-Spotify</div></div>
    </div>
  </div>

  <ul id="navLinks">
    <li><a href="index.html" class="chat">Chat-bot</a></li>
    <li><a href="bots.html" class="discord">Discord Bots</a></li>
    <li><a href="image.html" class="image">Image Gen</a></li>
    <li><a href="music.html" class="music">Music</a></li>
    <li><a href="video.html" class="video">Video Gen</a></li>
    <li><a href="home-automation.html" class="home">Home Automation</a></li>
  </ul>

  <div style="margin-left:auto;display:flex;align-items:center;gap:12px;color:var(--muted);font-size:13px">Logged in</div>
</nav>

<!-- PAGE -->
<div class="page">

  <!-- LEFT -->
  <aside class="sidebar" id="sidebar">
    <h3>Browse</h3>
    <div class="nav-item">üè† <strong>Home</strong></div>
    <div class="nav-item">üîç <strong>Search</strong></div>
    <div class="nav-item">üìö <strong>Your Library</strong></div>

    <div style="height:14px"></div>
    <div style="font-size:13px;color:var(--muted);font-weight:700">Playlists</div>
    <div class="playlist-list" id="sidebarPlaylists"></div>
    <button id="createPlaylistBtn">+ Create Playlist</button>
    <div style="height:12px"></div>
    <div style="font-size:13px;color:var(--muted)">Tip: click a card to play. Use + on a card to add to playlists.</div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="hero">
      <div>
        <div class="title">Featured</div>
        <div class="muted small">Popular & trending ‚Äî click a song to play</div>
      </div>

      <div class="searchbar">
        <input id="ytInput" placeholder="Search song or paste YouTube link here...">
        <button id="loadBtn">Search & Play</button>
      </div>
    </div>

    <div id="songGrid" class="song-grid" aria-live="polite">
      <!-- 3 demo songs (you can add more cards later) -->
      <div class="song-card" data-id="fHI8X4OXluQ" data-title="Blinding Lights" data-artist="The Weeknd" data-cover="https://i.ytimg.com/vi/fHI8X4OXluQ/hqdefault.jpg">
        <img class="song-cover" src="https://i.ytimg.com/vi/fHI8X4OXluQ/hqdefault.jpg" alt="">
        <div class="song-meta"><div class="title">Blinding Lights</div><div class="artist muted">The Weeknd</div></div>
        <button class="add-to-pl-btn" title="Add to playlist">+</button>
      </div>

      <div class="song-card" data-id="34Na4j8AVgA" data-title="Starboy" data-artist="The Weeknd" data-cover="https://i.ytimg.com/vi/34Na4j8AVgA/hqdefault.jpg">
        <img class="song-cover" src="https://i.ytimg.com/vi/34Na4j8AVgA/hqdefault.jpg" alt="">
        <div class="song-meta"><div class="title">Starboy</div><div class="artist muted">The Weeknd</div></div>
        <button class="add-to-pl-btn">+</button>
      </div>

      <div class="song-card" data-id="mRD0-GxqHVo" data-title="Heat Waves" data-artist="Glass Animals" data-cover="https://i.ytimg.com/vi/mRD0-GxqHVo/hqdefault.jpg">
        <img class="song-cover" src="https://i.ytimg.com/vi/mRD0-GxqHVo/hqdefault.jpg" alt="">
        <div class="song-meta"><div class="title">Heat Waves</div><div class="artist muted">Glass Animals</div></div>
        <button class="add-to-pl-btn">+</button>
      </div>
    </div>
  </main>

  <!-- RIGHT -->
  <aside class="right-panel">
    <h4>Now Playing</h4>
    <div style="display:flex;flex-direction:column;gap:10px">
      <div style="display:flex;gap:10px;align-items:center">
        <div style="width:56px;height:56px;border-radius:8px;overflow:hidden;background:#0b0f12">
          <img id="coverImgRight" src="https://i.ytimg.com/vi/fHI8X4OXluQ/hqdefault.jpg" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div>
          <div id="trackTitleRight" style="font-weight:700">Not Playing</div>
          <div id="trackArtistRight" class="muted">Paste a link or search to play</div>
        </div>
      </div>

      <div style="margin-top:8px">
        <div style="font-weight:700">Your Playlists</div>
        <div id="playlistArea" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- hidden iframe -->
    <iframe id="ytPlayer" style="display:none" allow="autoplay"></iframe>
  </aside>
</div>

<!-- BOTTOM PLAYER -->
<div class="player-bar">
  <div class="player-left">
    <div class="player-cover"><img id="miniCover" src="https://i.ytimg.com/vi/fHI8X4OXluQ/hqdefault.jpg" alt=""></div>
    <div class="player-meta">
      <div id="trackTitleBottom" class="title">Not Playing</div>
      <div id="trackArtistBottom" class="muted small">‚Äî</div>
    </div>
  </div>

  <div style="display:flex;flex-direction:column;align-items:center;flex:1">
    <div class="player-controls">
      <button class="btn" id="prevBtn">‚èÆ</button>
      <button class="btn" id="rewBtn" title="Rewind 10s">‚ü≤</button>
      <button class="btn play" id="playBtn">‚ñ∂</button>
      <button class="btn" id="fwdBtn" title="Forward 10s">‚ü≥</button>
      <button class="btn" id="nextBtn">‚è≠</button>
      <div class="progress" style="margin-left:18px"><i id="progressFill"></i></div>
    </div>

    <div class="wave-container" id="waveContainer" aria-hidden="true" style="margin-top:8px;height:28px"></div>
  </div>

  <div style="width:220px;display:flex;align-items:center;justify-content:flex-end;gap:12px">
    <div style="font-size:13px;color:var(--muted)">JARVIS</div>
  </div>
</div>

<script>
/* Consolidated inline JS ‚Äî fully wired (play, wave, progress, playlists, add-to-playlist) */

/* Config */
const STORAGE_KEY = "jarvis_playlists_v1";
const NUM_BARS = 20;

/* state */
let currentVideoId = null;
let isPlaying = false;
let progressInterval = null;
let waveBars = [];
let currentQueue = [];
let currentIndex = -1;

/* util */
function $(id){ return document.getElementById(id); }
function extractVideoId(url){
  if(!url) return null;
  url = url.trim();
  if(/^[A-Za-z0-9_-]{10,}$/.test(url)) return url;
  try{
    if(url.includes('youtu.be/')) return url.split('youtu.be/')[1].split(/[?&]/)[0];
    if(url.includes('v=')) return url.split('v=')[1].split('&')[0];
    const m = url.match(/\/embed\/([A-Za-z0-9_\-]+)/);
    if(m) return m[1];
    const maybe = url.match(/([A-Za-z0-9_-]{11})/);
    if(maybe) return maybe[1];
  }catch(e){}
  return null;
}

/* update UI (both right and bottom) */
function updateMetaDisplays(title, artist, coverUrl, vid){
  if($('coverImgRight') && coverUrl) $('coverImgRight').src = coverUrl;
  if($('miniCover') && coverUrl) $('miniCover').src = coverUrl;

  if($('trackTitleRight')) $('trackTitleRight').textContent = title || (`Video: ${vid||''}`);
  if($('trackArtistRight')) $('trackArtistRight').textContent = artist || 'YouTube';
  if($('trackTitleBottom')) $('trackTitleBottom').textContent = title || (`Video: ${vid||''}`);
  if($('trackArtistBottom')) $('trackArtistBottom').textContent = artist || 'YouTube';
}

/* set hidden iframe src to play */
function setIframeSrc(vid){
  const iframe = $('ytPlayer');
  if(!iframe) return;
  iframe.src = `https://www.youtube.com/embed/${vid}?autoplay=1&controls=1&rel=0&modestbranding=1`;
}

/* set current by id */
function setVideoById(vid){
  if(!vid) return;
  currentVideoId = vid;
  // set iframe (hidden) to play
  setIframeSrc(vid);
  // update covers
  const cover = `https://i.ytimg.com/vi/${vid}/hqdefault.jpg`;
  // fetch oembed for title/author
  fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${vid}&format=json`)
    .then(r => r.ok ? r.json() : null)
    .then(data => {
      updateMetaDisplays(data?.title || `Video: ${vid}`, data?.author_name || 'YouTube', cover, vid);
    }).catch(()=> {
      updateMetaDisplays(`Video: ${vid}`, 'YouTube', cover, vid);
    });

  // queue management: place into queue if not present
  const idx = currentQueue.indexOf(vid);
  if(idx !== -1) currentIndex = idx;
  else { currentQueue = [vid]; currentIndex = 0; }

  // start visual playback state
  isPlaying = true;
  updatePlayButton();
  setProgress(0);
  startProgressSimulation();
  startWaveAnimation();
  highlightGrid(vid);
}

/* play/pause toggle */
function togglePlay(){
  if(!currentVideoId) return alert('No song selected - click a song card or search/paste a YouTube link.');
  const iframe = $('ytPlayer');
  if(isPlaying){
    // pause: unload iframe (we're not using api)
    if(iframe) iframe.src = '';
    isPlaying = false;
    stopProgressSimulation();
    stopWaveAnimation();
  } else {
    if(iframe) setIframeSrc(currentVideoId);
    isPlaying = true;
    startProgressSimulation();
    startWaveAnimation();
  }
  updatePlayButton();
}
function updatePlayButton(){
  const el = $('playBtn'); if(!el) return;
  el.textContent = isPlaying ? '‚è∏' : '‚ñ∂';
}

/* progress simulation */
function setProgress(p){
  const pf = $('progressFill'); if(!pf) return;
  pf.style.width = `${Math.max(0,Math.min(100,p))}%`;
}
function startProgressSimulation(){
  stopProgressSimulation();
  let val = 0;
  progressInterval = setInterval(()=>{
    if(!isPlaying) return;
    val += 0.8;
    if(val>100) val = 0;
    setProgress(val);
  }, 450);
}
function stopProgressSimulation(){ if(progressInterval){ clearInterval(progressInterval); progressInterval = null; } }

/* wave */
function initWaveBars(){
  const container = $('waveContainer'); if(!container) return;
  container.innerHTML = '';
  waveBars = [];
  for(let i=0;i<NUM_BARS;i++){
    const b = document.createElement('div');
    b.className = 'wave-bar';
    b.style.setProperty('--scale', Math.random().toString());
    container.appendChild(b);
    waveBars.push(b);
  }
}
function startWaveAnimation(){ waveBars.forEach(b=> b.style.animationPlayState='running'); }
function stopWaveAnimation(){ waveBars.forEach(b=> b.style.animationPlayState='paused'); }

/* queue controls */
function next(){ if(!currentQueue.length) return alert('Queue empty'); currentIndex = (currentIndex+1)%currentQueue.length; setVideoById(currentQueue[currentIndex]); }
function prev(){ if(!currentQueue.length) return alert('Queue empty'); currentIndex = (currentIndex-1+currentQueue.length)%currentQueue.length; setVideoById(currentQueue[currentIndex]); }

/* playlists (localStorage) */
function loadPlaylistsFromStorage(){
  try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return []; const parsed = JSON.parse(raw); return Array.isArray(parsed)?parsed:[]; }catch(e){ return []; }
}
function savePlaylistsToStorage(list){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(list||[])); }catch(e){ console.error(e); } }
function createEmptyPlaylist(name){ return { id:`pl_${Date.now()}`, name: name||'New Playlist', songs: [] }; }

/* render playlists right-panel + sidebar */
function renderPlaylists(){
  const area = $('playlistArea'); const sidebarList = $('sidebarPlaylists');
  const pls = loadPlaylistsFromStorage();
  if(area){ area.innerHTML=''; if(pls.length===0){ const note = document.createElement('div'); note.style.color='var(--muted)'; note.textContent='No playlists yet ‚Äî create one with + Create Playlist.'; area.appendChild(note); }
    else {
      pls.forEach(pl=>{
        const wrap = document.createElement('div'); wrap.style.marginBottom='10px';
        const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
        const t = document.createElement('div'); t.textContent = `${pl.name} (${pl.songs.length})`; t.style.fontWeight='700';
        const ctr = document.createElement('div');
        const playAll = document.createElement('button'); playAll.className='btn'; playAll.textContent='‚ñ∂'; playAll.onclick=(e)=>{ e.stopPropagation(); if(!pl.songs.length) return alert('Empty playlist'); currentQueue = pl.songs.map(s=>s.videoId); currentIndex=0; setVideoById(currentQueue[0]); };
        const del = document.createElement('button'); del.className='btn'; del.textContent='üóë'; del.onclick=(e)=>{ e.stopPropagation(); if(!confirm(`Delete '${pl.name}'?`)) return; const all=loadPlaylistsFromStorage(); savePlaylistsToStorage(all.filter(x=>x.id!==pl.id)); renderPlaylists(); renderSidebarPlaylists(); };
        ctr.appendChild(playAll); ctr.appendChild(del);
        header.appendChild(t); header.appendChild(ctr);
        wrap.appendChild(header);

        if(!pl.songs.length){ const em = document.createElement('div'); em.style.color='var(--muted)'; em.textContent='No songs ‚Äî add from Featured.'; wrap.appendChild(em); }
        else {
          pl.songs.forEach(s=>{
            const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginTop='8px';
            const left = document.createElement('div'); left.style.display='flex'; left.style.gap='8px'; left.style.alignItems='center'; left.style.cursor='pointer';
            const thumb = document.createElement('img'); thumb.src = s.cover || `https://i.ytimg.com/vi/${s.videoId}/default.jpg`; thumb.style.width='46px'; thumb.style.height='46px'; thumb.style.objectFit='cover'; thumb.style.borderRadius='6px';
            const meta = document.createElement('div'); const tt = document.createElement('div'); tt.textContent = s.title || 'Unknown'; tt.style.fontWeight='600'; const aa = document.createElement('div'); aa.textContent = s.artist || ''; aa.style.fontSize='12px'; aa.style.color='var(--muted)';
            meta.appendChild(tt); meta.appendChild(aa);
            left.appendChild(thumb); left.appendChild(meta);
            left.onclick = ()=> setVideoById(s.videoId);
            const right = document.createElement('div'); const rem = document.createElement('button'); rem.className='btn'; rem.textContent='‚úñ'; rem.onclick=(e)=>{ e.stopPropagation(); if(!confirm(`Remove '${s.title}' from '${pl.name}'?`)) return; const all=loadPlaylistsFromStorage(); const targ = all.find(x=>x.id===pl.id); if(!targ) return; targ.songs = targ.songs.filter(x=>x.videoId !== s.videoId); savePlaylistsToStorage(all); renderPlaylists(); renderSidebarPlaylists(); };
            right.appendChild(rem);
            row.appendChild(left); row.appendChild(right); wrap.appendChild(row);
          });
        }

        area.appendChild(wrap);
      });
    }
  }

  if(sidebarList){
    sidebarList.innerHTML='';
    pls.forEach(pl=>{
      const btn = document.createElement('button'); btn.className='pl-btn'; btn.textContent = `${pl.name} (${pl.songs.length})`; btn.onclick = ()=>{ if(!pl.songs.length) return alert('Empty playlist'); currentQueue = pl.songs.map(s=>s.videoId); currentIndex = 0; setVideoById(currentQueue[0]); };
      sidebarList.appendChild(btn);
    });
  }
}
function renderSidebarPlaylists(){ renderPlaylists(); }

/* add song to playlist by id */
function addSongToPlaylist(playlistId, songObj){
  const all = loadPlaylistsFromStorage(); const pl = all.find(x=>x.id===playlistId);
  if(!pl) return alert('Playlist not found');
  if(pl.songs.some(s=>s.videoId===songObj.videoId)) return alert('Song already in playlist');
  pl.songs.push(songObj); savePlaylistsToStorage(all); renderPlaylists(); renderSidebarPlaylists(); alert(`Added "${songObj.title}" to "${pl.name}"`);
}

/* wire song grid cards */
function wireSongGrid(){
  const grid = $('songGrid'); if(!grid) return;
  const cards = Array.from(grid.querySelectorAll('.song-card'));
  cards.forEach(card=>{
    card.style.position = card.style.position || 'relative';
    card.addEventListener('click', (ev)=>{
      if(ev.target && ev.target.classList && ev.target.classList.contains('add-to-pl-btn')) return;
      const raw = card.getAttribute('data-id') || card.dataset.id || '';
      const vid = extractVideoId(raw) || raw;
      if(!vid) return alert('Invalid video id');
      const allIds = cards.map(c=> extractVideoId(c.getAttribute('data-id')||c.dataset.id) || (c.getAttribute('data-id')||c.dataset.id)).filter(x=>!!x);
      currentQueue = allIds; currentIndex = currentQueue.indexOf(vid); if(currentIndex===-1){ currentQueue=[vid]; currentIndex=0; }
      setVideoById(vid);
    });

    let addBtn = card.querySelector('.add-to-pl-btn');
    if(!addBtn){
      addBtn = document.createElement('button');
      addBtn.className = 'add-to-pl-btn';
      addBtn.textContent = '+';
      addBtn.title = 'Add to playlist';
      card.appendChild(addBtn);
    }
    addBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      openPlaylistChooserForCard(card, addBtn);
    });
  });
}

/* playlist chooser popover */
function openPlaylistChooserForCard(card, anchorBtn){
  const existing = document.getElementById('playlistChooserPopover'); if(existing) existing.remove();
  const playlists = loadPlaylistsFromStorage();
  const pop = document.createElement('div'); pop.id='playlistChooserPopover';
  pop.style.position='absolute'; pop.style.top=(anchorBtn.offsetTop + anchorBtn.offsetHeight + 6) + 'px'; pop.style.right='8px';
  pop.style.background='var(--panel)'; pop.style.color='var(--text)'; pop.style.padding='10px'; pop.style.borderRadius='8px'; pop.style.boxShadow='0 10px 30px rgba(0,0,0,0.6)'; pop.style.zIndex=9999; pop.style.minWidth='200px';
  const title = document.createElement('div'); title.textContent='Add to playlist'; title.style.fontWeight='700'; title.style.marginBottom='8px'; pop.appendChild(title);

  if(!playlists.length){
    const no = document.createElement('div'); no.textContent='No playlists yet.'; no.style.color='var(--muted)'; no.style.marginBottom='8px'; pop.appendChild(no);
    const createNow = document.createElement('button'); createNow.textContent = '+ Create'; createNow.style.background='var(--accent-2)'; createNow.style.border='none'; createNow.style.padding='8px 10px'; createNow.style.borderRadius='8px'; createNow.style.cursor='pointer';
    createNow.onclick = ()=>{ const name = prompt('Playlist name:'); if(!name) return; const all = loadPlaylistsFromStorage(); all.push(createEmptyPlaylist(name)); savePlaylistsToStorage(all); renderPlaylists(); renderSidebarPlaylists(); pop.remove(); };
    pop.appendChild(createNow);
  } else {
    playlists.forEach(pl=>{
      const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginBottom='8px'; row.style.cursor='pointer';
      const left = document.createElement('div'); left.textContent = pl.name; left.style.color='var(--text)'; left.onclick = ()=>{
        const raw = card.getAttribute('data-id') || card.dataset.id || ''; const vid = extractVideoId(raw) || raw;
        if(!vid) return alert('Invalid video id');
        const songObj = { videoId: vid, title: card.getAttribute('data-title')||card.dataset.title|| card.querySelector('.title')?.textContent||'Unknown', artist: card.getAttribute('data-artist')||card.dataset.artist|| card.querySelector('.artist')?.textContent||'', cover: card.getAttribute('data-cover')||card.dataset.cover|| card.querySelector('img')?.src||'' };
        addSongToPlaylist(pl.id, songObj); const chooser = document.getElementById('playlistChooserPopover'); if(chooser) chooser.remove();
      };
      const cnt = document.createElement('div'); cnt.textContent = `${pl.songs.length}`; cnt.style.color='var(--muted)';
      row.appendChild(left); row.appendChild(cnt); pop.appendChild(row);
    });
  }

  card.appendChild(pop);
  setTimeout(()=> document.addEventListener('click', function close(e){ if(!pop.contains(e.target) && e.target !== anchorBtn){ pop.remove(); document.removeEventListener('click', close); } }), 50);
}

/* highlight current playing */
function highlightGrid(vid){
  const grid = $('songGrid'); if(!grid) return;
  Array.from(grid.querySelectorAll('.song-card')).forEach(c=>{
    const raw = c.getAttribute('data-id') || c.dataset.id || ''; const id = extractVideoId(raw) || raw;
    c.style.outline = (id && vid && id===vid) ? '2px solid rgba(29,123,255,0.85)' : 'none';
  });
}

/* search/load */
async function loadMusic(){
  const input = $('ytInput'); if(!input) return alert('Search input missing');
  const raw = input.value.trim(); if(!raw) return alert('Type a YouTube link or search query');
  const isUrl = /(youtube\.com|youtu\.be)/i.test(raw);
  if(isUrl){
    const vid = extractVideoId(raw); if(!vid) return alert('Could not extract video id'); currentQueue=[vid]; currentIndex=0; setVideoById(vid); return;
  }
  // try backend /api/search if available
  try{
    const resp = await fetch(`/api/search?q=${encodeURIComponent(raw)}`);
    if(!resp.ok) throw new Error('no-api');
    const data = await resp.json();
    if(!data || !data.videoId) throw new Error('no-results');
    const vid = data.videoId;
    currentQueue=[vid]; currentIndex=0; setVideoById(vid);
  }catch(err){
    alert('Search failed or no API available. Paste a YouTube link or try another query.');
  }
}

/* init */
document.addEventListener('DOMContentLoaded', ()=>{
  initWaveBars();
  wireSongGrid();
  renderPlaylists();

  $('loadBtn')?.addEventListener('click', loadMusic);
  $('ytInput')?.addEventListener('keydown', e=>{ if(e.key==='Enter') loadMusic(); });

  $('playBtn')?.addEventListener('click', ()=>{ if(!currentVideoId){ // if nothing selected, try cue first card
      const first = document.querySelector('.song-card'); if(first){ const vid = extractVideoId(first.getAttribute('data-id')||first.dataset.id); if(vid) setVideoById(vid); else return alert('No playable song'); }
    } else togglePlay(); });

  $('nextBtn')?.addEventListener('click', next);
  $('prevBtn')?.addEventListener('click', prev);
  $('rewBtn')?.addEventListener('click', ()=> alert('Precise seek requires YouTube IFrame API; ask me to add it.'));
  $('fwdBtn')?.addEventListener('click', ()=> alert('Precise seek requires YouTube IFrame API; ask me to add it.'));

  $('createPlaylistBtn')?.addEventListener('click', ()=>{
    const name = prompt('Playlist name:'); if(!name) return; const all = loadPlaylistsFromStorage(); all.push(createEmptyPlaylist(name)); savePlaylistsToStorage(all); renderPlaylists(); renderSidebarPlaylists();
  });

  // hamburger
  document.getElementById('hamburger')?.addEventListener('click', ()=>{
    document.getElementById('navLinks')?.classList.toggle('active');
    document.getElementById('sidebar')?.classList.toggle('open');
  });
});

/* expose for console debugging */
window.setVideoById = setVideoById;
window.loadMusic = loadMusic;
window.next = next;
window.prev = prev;
</script>
</body>
</html>
